# 高德地图语音导航助手 - 架构说明

## 导航模式架构

### 🚀 七牛云MCP模式

**流程:**
```
用户语音/文字输入 
    ↓
AI提取起点终点
    ↓
七牛云MCP SERVER (maps_geo工具)
    ↓
获取精确经纬度坐标
    ↓
构建高德地图导航URL
    ↓
浏览器打开导航页面
```

**技术特点:**
- 直接调用七牛云MCP SERVER的maps_geo工具
- 单次API调用获取坐标
- 响应速度快，网络开销小
- 坐标精度高，专业地理编码服务

**配置要求:**
- OPENAI_BASE_URL: 七牛云MCP服务器地址
- OPENAI_API_KEY: 七牛云MCP API密钥
- MCP_MODEL: 使用的模型 (默认: deepseek-v3-tool)

### 🔄 传统MCP模式

**流程:**
```
用户语音/文字输入
    ↓
AI处理和地址验证
    ↓
高德地图API地理编码
    ↓
获取经纬度坐标
    ↓
构建高德地图导航URL
    ↓
浏览器打开导航页面
```

**技术特点:**
- 使用高德地图官方API
- 包含地址验证步骤
- 支持多种地理编码选项
- 兼容性好，功能丰富

**配置要求:**
- AMAP_API_KEY: 高德地图API密钥
- AMAP_API_BASE_URL: 高德API基础地址
- AMAP_REQUEST_TIMEOUT: API请求超时时间

## 关键组件

### 1. 导航客户端选择器
- **文件**: `main.py` - `NavigationApp.test_and_select_mcp_client()`
- **功能**: 自动检测可用的导航客户端并选择最佳方案
- **逻辑**: 优先使用配置启用的客户端，回退到可用的备选方案

### 2. 七牛云MCP客户端
- **文件**: `qiniu_mcp_client.py` - `QiniuMCPClient`
- **功能**: 封装七牛云MCP SERVER调用逻辑
- **特点**: 直接解析MCP响应中的坐标信息

### 3. 传统MCP客户端
- **文件**: `mcp_client.py` - `MCPClient`
- **功能**: 封装高德地图API调用逻辑
- **特点**: 包含完整的地址验证和错误处理

### 4. 浏览器导航器
- **文件**: `browser_navigator.py` - `BrowserNavigator`
- **功能**: 构建高德地图URL并打开浏览器
- **说明**: 这是两种模式的共同最终步骤，不是独立的导航模式

## 配置管理

### 统一配置加载
- **文件**: `config.py`
- **特点**: 统一从环境变量读取所有配置
- **依赖**: `env_loader.py` 负责.env文件加载

### 环境变量优先级
1. 系统环境变量
2. .env文件配置
3. 代码中的默认值

### 配置验证
- **函数**: `config.validate_config()`
- **功能**: 检查必需配置项是否完整
- **返回**: 缺失配置项列表

## 用户交互

### 命令系统
- `voice`: 启动语音输入
- `client`: 切换导航客户端模式
- `quit/exit`: 退出程序

### 语音确认流程
1. 播报导航计划
2. 语音识别确认指令
3. 支持关键词触发 ("确认", "开始导航", "取消"等)
4. 超时自动提供手动选择

## 错误处理

### 分层错误处理
1. **网络层**: 连接超时、API错误
2. **数据层**: 坐标解析失败、地址验证失败
3. **用户层**: 语音播报错误信息，提供备选方案

### 自动降级
- 七牛云MCP失败 → 自动切换到传统MCP
- 科大讯飞语音失败 → 自动切换到Google语音识别
- API调用失败 → 提供手动输入选项

## 性能优化

### 缓存机制
- TTS引擎缓存
- 音频文件缓存
- 配置信息缓存

### 异步处理
- 语音识别异步执行
- 网络请求超时控制
- 用户界面响应优化

## 扩展性

### 新增导航客户端
1. 实现客户端接口 (参考现有客户端)
2. 在NavigationApp中注册新客户端
3. 添加配置项和环境变量
4. 更新用户界面选项

### 新增语音引擎
1. 在speech_handler.py中添加引擎支持
2. 更新TTS引擎选择逻辑
3. 添加相应的配置项

这种架构设计确保了系统的模块化、可扩展性和用户友好性，同时保持了代码的清晰性和维护性。